<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown/MathJax Editor</title>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            /* Height will be set by JS based on window.innerHeight or visualViewport.height */
            height: var(--app-viewport-height, 100vh); /* Fallback to 100vh */
            overflow: hidden; /* Prevent body scroll, content areas will scroll */
            background-color: #f4f7f6;
            color: #333;
            padding-bottom: 0; /* Will be set by JS dynamically to make space for toolbar */
        }

        .container {
            flex-grow: 1; /* Allows the container to take available space */
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px; /* Spacing between textarea and render output */
            overflow: hidden; /* Important for containing scrolling children */
            /* Height will be explicitly set by JS */
            height: auto; /* Allow flex-grow to work, JS will override */
        }

        #markdownInput, #renderOutput {
            flex-grow: 1; /* Both take equal space within the container */
            width: 100%;
            border: 1px solid #dcdcdc;
            padding: 15px;
            box-sizing: border-box; /* Include padding/border in element's total width/height */
            font-size: 1rem;
            line-height: 1.6;
            border-radius: 8px;
            transition: border-color 0.2s ease-in-out;
            overflow-y: auto; /* Enable scrolling for content */
        }

        #markdownInput {
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', 'Monaco', monospace; /* Preferred coding font */
            resize: none; /* Disable manual textarea resize */
            background-color: #fff;
            color: #222;
        }

        #markdownInput:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.25);
        }

        #renderOutput {
            background-color: #e9ecef;
            color: #333;
            /* Basic styling for rendered markdown content */
            font-family: sans-serif;
        }

        #renderOutput h1, #renderOutput h2, #renderOutput h3, #renderOutput h4, #renderOutput h5, #renderOutput h6 {
            color: #0056b3;
            margin-top: 1em;
            margin-bottom: 0.5em;
        }

        #renderOutput p {
            margin-bottom: 1em;
        }

        #renderOutput pre {
            background-color: #f8f9fa;
            border: 1px solid #ced4da;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }

        #renderOutput code {
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', 'Monaco', monospace;
            background-color: #f0f0f0;
            padding: 2px 4px;
            border-radius: 3px;
        }

        .hidden {
            display: none !important; /* Utility class to hide elements */
        }

        #toolbar {
            position: fixed; /* Keep it fixed at the bottom */
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            flex-wrap: nowrap; /* Prevent wrapping, force single line */
            overflow-x: auto; /* Enable horizontal scrolling */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            gap: 10px; /* Space between toolbar items */
            padding: 15px;
            background-color: #f0f0f0;
            border-top: 1px solid #e0e0e0;
            justify-content: flex-start; /* Align items to the start */
            align-items: center; /* Vertically align items */
            min-height: 50px; /* Ensure toolbar has some height */
            box-sizing: border-box; /* Include padding in width/height */
            z-index: 999; /* Ensure it's above other content but below console */
        }

        #toolbar button {
            /* Prevent buttons from shrinking too much */
            flex-shrink: 0;
            padding: 10px 18px;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            border-radius: 5px;
            font-size: 0.95rem;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #toolbar button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        #toolbar button:active {
            background-color: #004085;
            transform: translateY(0);
        }

        /* --- Floating Console Styles --- */
        #floatingConsole {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px; /* Adjust as needed */
            height: 300px; /* Adjust as needed */
            background-color: #222;
            border: 1px solid #555;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            z-index: 1000; /* Ensure it's on top of other content */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Hide scrollbars on the console div itself, content will scroll */
        }

        #floatingConsole.hidden {
            display: none;
        }

        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background-color: #333;
            color: #eee;
            font-weight: bold;
            border-bottom: 1px solid #555;
            cursor: grab; /* Indicate it's draggable if dragging functionality were added */
        }

        .console-close-btn {
            background: none;
            border: none;
            color: #eee;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            margin: 0;
            transition: color 0.2s;
        }

        .console-close-btn:hover {
            color: #f00; /* Red on hover */
        }

        #consoleOutput {
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for console messages */
            padding: 10px 15px;
            font-family: 'Fira Code', 'Consolas', monospace;
            font-size: 0.85rem;
            color: #eee;
            white-space: pre-wrap; /* Preserve whitespace and wrap long lines */
            word-break: break-all; /* Break long words that exceed container width */
        }

        #consoleOutput .console-line {
            margin-bottom: 5px;
            line-height: 1.4;
        }

        #consoleOutput .console-info {
            color: #eee; /* Default text color for info messages */
        }

        #consoleOutput .console-warn {
            color: #ffc107; /* Yellow for warnings */
        }

        #consoleOutput .console-error {
            color: #dc3545; /* Red for errors */
            font-weight: bold;
        }

        /* Basic responsiveness for smaller screens */
        @media (max-width: 768px) {
            #floatingConsole {
                width: 90%;
                height: 50vh; /* Use viewport height for better fitting on mobile */
                bottom: 10px;
                right: 5%;
                left: 5%;
            }
        }

        /* --- Print-specific Styles --- */
        @media print {
            #toolbar,
            #floatingConsole,
            #markdownInput, /* Also hide the input area when printing */
            #toggleViewBtn,
            #toggleConsoleBtn,
            #insertExampleBtn, /* Hide specific buttons if you want */
            #printBtn {
                display: none !important;
            }

            body {
                padding-bottom: 0 !important; /* Remove padding from toolbar space */
                height: auto !important; /* Allow body height to be natural for printing */
            }

            /* Ensure only the rendered output is visible and takes full width/height */
            .container {
                display: block; /* Change to block for print layout */
                padding: 0; /* Remove container padding for print */
                height: auto !important; /* Allow content to dictate height for print */
            }
            #renderOutput {
                display: block !important; /* Make sure it's always visible for print */
                width: auto !important;
                height: auto !important;
                flex-grow: 0 !important;
                border: none !important;
                box-shadow: none !important;
                background-color: transparent !important;
                overflow: visible !important; /* Allow content to print beyond initial view */
            }
        }
    </style>

    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                packages: {'[+]': ['ams', 'newcommand']}
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'annotation', 'annotation-xml']
            }
        };
    </script>

    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script src="addons/addons.js" defer></script>

</head>
<body>
    <div class="container">
        <textarea id="markdownInput" placeholder="Type your Markdown or MathJax here..."></textarea>

        <div id="renderOutput" class="hidden"></div>
    </div>

    <div id="toolbar">
        <button id="toggleViewBtn">Show Rendered</button>
        <button id="toggleConsoleBtn">Show Console</button>
    </div>

    <div id="floatingConsole" class="hidden">
        <div class="console-header">
            <span>Console</span>
            <button id="closeConsoleBtn" class="console-close-btn">&times;</button>
        </div>
        <div id="consoleOutput" class="console-output"></div>
    </div>

    <script>
        // Configure Marked.js with an extension to properly handle MathJax display blocks.
        marked.use({
            extensions: [{
                name: 'mathBlock',
                level: 'block',
                start(src) {
                    return src.match(/^ {0,3}\$\$/m);
                },
                tokenizer(src, tokens) {
                    const rule = /^ {0,3}\$\$([\\s\\S]*?)\$\$ *(?:\n|$)/;
                    const match = rule.exec(src);
                    if (match) {
                        const formula = match[1].trim();
                        return {
                            type: 'mathBlock',
                            raw: match[0],
                            formula: formula,
                            tokens: []
                        };
                    }
                },
                renderer(token) {
                    return `<div class="mathjax-display">$$\n${token.formula}\n$$</div>\n`;
                }
            }]
        });

        // --- Floating Console Logic ---
        const originalConsoleLog = console.log;
        const originalConsoleWarn = console.warn;
        const originalConsoleError = console.error;

        const pendingConsoleMessages = [];

        function appendToCustomConsole(type, args) {
            const message = Array.from(args).map(arg => {
                if (typeof arg === 'object' && arg !== null) {
                    try {
                        const cache = new Set();
                        return JSON.stringify(arg, (key, value) => {
                            if (typeof value === 'object' && value !== null) {
                                if (cache.has(value)) {
                                    return;
                                }
                                cache.add(value);
                            }
                            return value;
                        }, 2);
                    } catch (e) {
                        return String(arg);
                    }
                }
                return String(arg);
            }).join(' ');

            if (window.consoleOutput) {
                const line = document.createElement('div');
                line.classList.add('console-line', `console-${type}`);
                line.textContent = message;
                window.consoleOutput.appendChild(line);
                window.consoleOutput.scrollTop = window.consoleOutput.scrollHeight;
            } else {
                pendingConsoleMessages.push({ type, message });
            }
        }

        console.log = function(...args) {
            appendToCustomConsole('info', args);
            originalConsoleLog.apply(console, args);
        };

        console.warn = function(...args) {
            appendToCustomConsole('warn', args);
            originalConsoleWarn.apply(console, args);
        };

        console.error = function(...args) {
            appendToCustomConsole('error', args);
            originalConsoleError.apply(console, args);
        };
        // --- End Floating Console Logic ---


        /**
         * The main application module, encapsulating all core functionalities.
         * It provides methods for rendering content, toggling views, and an API for add-ons.
         */
        const App = (() => {
            let markdownInput;
            let renderOutput;
            let toggleViewBtn;
            let toolbar;
            let container;
            let isCodeView = true;

            const renderContent = () => {
                const markdownText = markdownInput.value;
                const html = marked.parse(markdownText);
                renderOutput.innerHTML = html;
                console.log("Marked.js Output HTML:\n" + html);
                console.log("Rendered HTML updated.");

                if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                    MathJax.typesetPromise([renderOutput])
                        .catch(err => console.error("MathJax typesetting error:", err));
                }
            };

            const toggleView = (forceView) => {
                const newIsCodeView = forceView === 'code' ? true : (forceView === 'render' ? false : !isCodeView);

                if (isCodeView === newIsCodeView) {
                    return;
                }

                isCodeView = newIsCodeView;

                if (isCodeView) {
                    markdownInput.classList.remove('hidden');
                    renderOutput.classList.add('hidden');
                    toggleViewBtn.textContent = 'Show Rendered';
                    markdownInput.focus();
                    console.log("Switched to Code View.");
                } else {
                    renderContent();
                    markdownInput.classList.add('hidden');
                    renderOutput.classList.remove('hidden');
                    toggleViewBtn.textContent = 'Show Code';
                    console.log("Switched to Rendered View.");
                }
            };

            const addToolbarItem = (elementOrHtmlString) => {
                if (typeof elementOrHtmlString === 'string') {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = elementOrHtmlString;
                    while (tempDiv.firstChild) {
                        toolbar.appendChild(tempDiv.firstChild);
                    }
                } else if (elementOrHtmlString instanceof HTMLElement) {
                    toolbar.appendChild(elementOrHtmlString);
                } else {
                    console.warn("App.addToolbarItem: Invalid item type. Must be HTMLElement or HTML string.", elementOrHtmlString);
                }
                adjustLayout();
            };

            const getContent = () => markdownInput.value;

            const setContent = (newContent) => {
                markdownInput.value = newContent;
                if (!isCodeView) {
                    renderContent();
                }
                console.log("Content updated.");
            };

            const getIsCodeView = () => isCodeView;

            const adjustLayout = () => {
                if (toolbar && container) {
                    const toolbarHeight = toolbar.offsetHeight;
                    let viewportHeight = window.innerHeight;

                    if (window.visualViewport) {
                        viewportHeight = window.visualViewport.height;
                    }

                    document.body.style.setProperty('--app-viewport-height', `${viewportHeight}px`);
                    container.style.height = `${viewportHeight - toolbarHeight}px`;
                    document.body.style.paddingBottom = `${toolbarHeight}px`;

                    console.log(`Layout Adjusted: Viewport=${viewportHeight}px, Toolbar=${toolbarHeight}px, Container=${container.style.height}, Body Padding=${document.body.style.paddingBottom}`);
                }
            };

            const initApp = () => {
                markdownInput = document.getElementById('markdownInput');
                renderOutput = document.getElementById('renderOutput');
                toggleViewBtn = document.getElementById('toggleViewBtn');
                toolbar = document.getElementById('toolbar');
                container = document.querySelector('.container');

                window.floatingConsole = document.getElementById('floatingConsole');
                window.toggleConsoleBtn = document.getElementById('toggleConsoleBtn');
                window.closeConsoleBtn = document.getElementById('closeConsoleBtn');
                window.consoleOutput = document.getElementById('consoleOutput');

                pendingConsoleMessages.forEach(msg => {
                    const line = document.createElement('div');
                    line.classList.add('console-line', `console-${msg.type}`);
                    line.textContent = msg.message;
                    window.consoleOutput.appendChild(line);
                });
                pendingConsoleMessages.length = 0;

                if (window.toggleConsoleBtn) {
                    window.toggleConsoleBtn.addEventListener('click', () => {
                        window.floatingConsole.classList.toggle('hidden');
                        console.log("Console visibility toggled.");
                    });
                }
                if (window.closeConsoleBtn) {
                    window.closeConsoleBtn.addEventListener('click', () => {
                        window.floatingConsole.classList.add('hidden');
                        console.log("Console closed.");
                    });
                }

                toggleViewBtn.addEventListener('click', () => toggleView());

                markdownInput.addEventListener('input', () => {
                    if (!isCodeView) {
                        renderContent();
                    }
                });

                // IMPORTANT: addonList is now expected to be loaded globally from addons/addons.js
                // No need to define it here anymore.
                if (typeof addonList !== 'undefined' && Array.isArray(addonList)) {
                    addonList.forEach(addonFileName => {
                        const script = document.createElement('script');
                        script.src = `addons/${addonFileName}`;
                        script.defer = true;
                        script.onerror = () => console.error(`Failed to load addon: ${addonFileName}`);
                        document.body.appendChild(script);
                        console.log(`Attempting to load addon: ${addonFileName}`);
                    });
                } else {
                    console.warn("addonList not found or is not an array. No custom addons will be loaded. Ensure addons/addons.js is loaded correctly.");
                }

                adjustLayout();
                window.addEventListener('resize', adjustLayout);
                if (window.visualViewport) {
                    window.visualViewport.addEventListener('resize', adjustLayout);
                    console.log("Listening to visualViewport resize events for precise layout adjustments.");
                }

                markdownInput.focus();
                renderContent();
                console.log("Application initialized successfully!");
            };

            return {
                initApp: initApp,
                addToolbarItem: addToolbarItem,
                getContent: getContent,
                setContent: setContent,
                toggleView: toggleView,
                renderContent: renderContent,
                getIsCodeView: getIsCodeView
            };
        })();

        window.initApp = App.initApp;
        window.App = App;

        // The old `addonList` definition has been removed from here.

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof initApp === 'function') {
                initApp();
            } else {
                console.error("App initialization function (initApp) not found. Check embedded script.");
            }
        });
    </script>
</body>
</html>
